<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Gift Overlay - TikHub</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        
        .overlay-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: transparent;
        }
        
        .gift-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            background: transparent;
            font-family: 'Comic Sans MS', cursive;
            color: #fff;
        }
        
        .gift-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-height: 200px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.5;
            z-index: 1;
            pointer-events: none;
        }
        
        .title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: #ffffff;
            font-weight: bold;
            text-shadow: 2px 2px 0px #242424;
            z-index: 2;
        }
        
        .username {
            position: absolute;
            top: 125px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            color: #ffffff;
            font-weight: bold;
            text-shadow: 2px 2px 0px #242424;
            z-index: 2;
        }
        
        .gift-value {
            position: absolute;
            top: 165px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 22px;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 2px 2px 0px #242424;
            z-index: 2;
        }
        
        .connection-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 16px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="overlay-container">
        <div class="gift-overlay" id="giftOverlay" style="display: none;">
            <div class="gift-image" id="giftImage"></div>
            <div class="title" id="title">Top Gift</div>
            <div class="username" id="username">GamerPro123</div>
            <div class="gift-value" id="giftValue">5,000 coins</div>
        </div>
        
        <div class="connection-status" id="connectionStatus">
            Connecting to stream...
        </div>
    </div>

    <script>
        // Start with default preview data
        let topGift = {
            username: 'USERNAME',
            giftName: 'TikTok Universe',
            giftValue: 0,
            giftImage: 'https://p16-webcast.tiktokcdn.com/img/maliva/webcast-va/8f471afbcebfda3841a6cc515e381f58~tplv-obj.webp'
        };
        let isConnected = false;

        // Show preview immediately
        updateOverlay();

        // Connect to WebSocket for real-time gift data
        const ws = new WebSocket('wss://tikhub-overlay-server.onrender.com/ws/topgift');
        
        ws.onopen = () => {
            console.log('âœ… [TopGift] Connected to overlay WebSocket');
            isConnected = true;
            // Keep showing preview, don't show "Waiting for gifts..."
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('[TopGift] Received WebSocket message:', data);
                
                if (data.type === 'gift' && data.giftData) {
                    const gift = data.giftData;
                    const giftData = {
                        username: gift.nickname || gift.username || 'Anonymous',
                        giftName: gift.giftName || 'Gift',
                        giftValue: gift.diamondCount || gift.giftValue || 0,
                        giftImage: gift.giftPictureUrl || gift.giftImage || ''
                    };
                    
                    console.log('[TopGift] Processed gift:', giftData);
                    
                    // Update top gift if this is a higher value gift
                    if (!topGift || giftData.giftValue > topGift.giftValue) {
                        console.log(`ðŸ† [TopGift] New top gift! ${giftData.username} - ${giftData.giftName} (${giftData.giftValue} coins)`);
                        topGift = giftData;
                        updateOverlay();
                    }
                }
            } catch (error) {
                console.error('[TopGift] Error parsing gift data:', error);
            }
        };

        ws.onclose = () => {
            console.log('Disconnected from gift overlay WebSocket');
            isConnected = false;
            updateConnectionStatus('Disconnected from stream');
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            isConnected = false;
            updateConnectionStatus('Connection error');
        };

        function updateOverlay() {
            if (!topGift) return;

            const giftOverlay = document.getElementById('giftOverlay');
            const giftImage = document.getElementById('giftImage');
            const title = document.getElementById('title');
            const username = document.getElementById('username');
            const giftValue = document.getElementById('giftValue');

            // Update gift image
            console.log('[TopGift] Setting gift image:', topGift.giftImage);
            giftImage.style.backgroundImage = `url(${topGift.giftImage})`;
            console.log('[TopGift] Applied background-image:', giftImage.style.backgroundImage);
            
            // Update text content
            username.textContent = topGift.username;
            giftValue.textContent = `${topGift.giftValue.toLocaleString()} coins`;

            // Show overlay
            giftOverlay.style.display = 'block';
            document.getElementById('connectionStatus').style.display = 'none';
            
            console.log('[TopGift] Overlay updated. Gift image element:', giftImage);
        }

        function updateConnectionStatus(message) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.style.display = 'block';
            document.getElementById('giftOverlay').style.display = 'none';
        }

        // Load settings from URL parameters or localStorage
        function loadSettings() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Apply custom settings if provided
            const title = urlParams.get('title') || 'Top Gift';
            const titleSize = urlParams.get('titleSize') || '18';
            const usernameSize = urlParams.get('usernameSize') || '32';
            const fontSize = urlParams.get('fontSize') || '22';
            const titleColor = urlParams.get('titleColor') || '#ffffff';
            const usernameColor = urlParams.get('usernameColor') || '#ffffff';
            const counterColor = urlParams.get('counterColor') || '#ffd700';
            const fontFamily = urlParams.get('fontFamily') || 'Comic Sans MS';
            const giftImageOpacity = urlParams.get('giftImageOpacity') || '100';

            // Apply settings to elements
            document.getElementById('title').textContent = title;
            document.getElementById('title').style.fontSize = titleSize + 'px';
            document.getElementById('username').style.fontSize = usernameSize + 'px';
            document.getElementById('giftValue').style.fontSize = fontSize + 'px';
            document.getElementById('title').style.color = titleColor;
            document.getElementById('username').style.color = usernameColor;
            document.getElementById('giftValue').style.color = counterColor;
            
            // Apply font family to all text elements
            const textElements = document.querySelectorAll('.title, .username, .gift-value');
            textElements.forEach(el => {
                el.style.fontFamily = fontFamily;
            });

            // Apply gift image opacity
            document.getElementById('giftImage').style.opacity = giftImageOpacity / 100;
        }

        // Load settings when page loads
        loadSettings();
    </script>
</body>
</html>
